"""Agent Asteroid implementation for CVE-2024-50550"""

import re

from packaging import version

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VERSION_PATTERN = re.compile(r"Stable tag:\s(\d+\.\d+\.\d+)")
MAX_VULNERABLE_VERSION = version.parse("6.5.1")
VULNERABILITY_TITLE = "LiteSpeed Cache Vulnerability Allowing privilege escalation"
VULNERABILITY_REFERENCE = "CVE-2024-50550"
VULNERABILITY_DESCRIPTION = (
    "Incorrect Privilege Assignment vulnerability in LiteSpeed Technologies LiteSpeed Cache allows Privilege Escalation."
    "This issue affects LiteSpeed Cache versions before 6.5.2."
)
RISK_RATING = "HIGH"


@exploits_registry.register
class CVE202450550Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(
        method="GET", path="/wp-content/plugins/litespeed-cache/readme.txt"
    )
    check_request = definitions.Request(
        method="GET", path="/wp-content/plugins/litespeed-cache/readme.txt"
    )
    accept_pattern = [re.compile("LiteSpeed Cache")]
    version_pattern = VERSION_PATTERN
    vuln_ranges = [definitions.VulnRange(None, MAX_VULNERABLE_VERSION)]

    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
        cve_ids=["CVE-2024-50550"],
    )
