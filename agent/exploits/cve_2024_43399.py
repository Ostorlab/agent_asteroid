"""Agent Asteroid implementation for CVE-2024-43399"""

import re

from packaging import version

from agent.exploits import webexploit
from agent import exploits_registry
from agent import definitions

VULNERABILITY_TITLE = "Mobile Security Framework (MobSF) Zip Slip"
VULNERABILITY_REFERENCE = "CVE-2024-43399"
VULNERABILITY_DESCRIPTION = """Mobile Security Framework (MobSF) Before 4.0.7 is vulnerable 
to a flaw in the Static Libraries analysis section. 
Specifically, during the extraction of .a extension files, the measure intended to prevent 
Zip Slip attacks is improperly implemented. Since the implemented measure can be bypassed, 
the vulnerability allows an attacker to extract files to any desired location within the server 
running MobSF. This vulnerability is fixed in 4.0.7.
"""
RISK_RATING = "CRITICAL"
MAX_VULNERABLE_VERSION = version.parse("4.0.6")
VERSION_PATTERN = re.compile(r"<b>Version</b>\s(\d+\.\d+\.\d+)")


@exploits_registry.register
class CVE202443399Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/")
    check_request = definitions.Request(method="GET", path="/")
    accept_pattern = [re.compile("Mob<strong>SF</strong>")]
    vuln_ranges = [definitions.VulnRange(None, MAX_VULNERABLE_VERSION)]
    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
    )
    version_pattern = VERSION_PATTERN
