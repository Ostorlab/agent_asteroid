"""Agent Asteroid implementation for CVE-2024-2194"""

import re

from packaging import version

from agent.exploits import webexploit
from agent import exploits_registry
from agent import definitions

VULNERABILITY_TITLE = "WP Statistics Unauthenticated Stored Cross-Site Scripting"
VULNERABILITY_REFERENCE = "CVE-2024-2194"
VULNERABILITY_DESCRIPTION = """The WP Statistics plugin for WordPress is vulnerable to Stored Cross-Site Scripting 
via the URL search parameter in all versions up to, and including, 14.5 due to insufficient input sanitization and 
output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that 
will execute whenever a user accesses an injected page.
"""

RISK_RATING = "HIGH"
MAX_VULNERABLE_VERSION = version.parse("14.5")
VERSION_PATTERN = re.compile(r"tracker\.js\?ver=(\d+\.\d+(\.\d+)?)")


@exploits_registry.register
class CVE20242194Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/")
    check_request = definitions.Request(method="GET", path="/")
    accept_pattern = [re.compile("Analytics by")]
    vuln_ranges = [definitions.VulnRange(None, MAX_VULNERABLE_VERSION)]
    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
    )
    version_pattern = VERSION_PATTERN
