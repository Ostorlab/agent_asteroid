"""Agent Asteroid implementation for CVE-2024-8672"""

import re

from packaging import version

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VERSION_PATTERN = re.compile(r"Stable tag:\s(\d+\.\d+(?:\.\d+)*)")
MAX_VULNERABLE_VERSION = version.parse("4.0.7")
VULNERABILITY_TITLE = (
    "Widget Options Plugin <= 4.0.7 - Authenticated Remote Code Execution"
)
VULNERABILITY_REFERENCE = "CVE-2024-8672"
VULNERABILITY_DESCRIPTION = (
    "The Widget Options â€“ The #1 WordPress Widget & Block Control Plugin is "
    "vulnerable to Authenticated Remote Code Execution in all versions up to, and "
    "including, 4.0.7 via the display logic functionality that extends several page "
    "builders. This vulnerability allows users with contributor-level access or higher "
    "to execute arbitrary PHP code on the server due to input being passed to eval() "
    "without proper sanitization or filtering."
)
RISK_RATING = "CRITICAL"


@exploits_registry.register
class CVE20248672Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(
        method="GET", path="/wp-content/plugins/widget-options/readme.txt"
    )
    check_request = definitions.Request(
        method="GET", path="/wp-content/plugins/widget-options/readme.txt"
    )
    accept_pattern = [re.compile("Widget Options - Add Context To WordPress Widgets")]
    version_pattern = VERSION_PATTERN
    vuln_ranges = [definitions.VulnRange(None, MAX_VULNERABLE_VERSION)]

    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
        cve_ids=["CVE-2024-8672"],
    )
