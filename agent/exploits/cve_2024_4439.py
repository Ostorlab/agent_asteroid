"""Agent Asteroid implementation for CVE-2024-4439"""

import re

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

# Vulnerable versions:  6.0 <= version <= 6.0.7
#                       6.1 <= version <= 6.1.5
#                       6.2 <= version <= 6.2.4
#                       6.3 <= version <= 6.3.3
#                       6.4 <= version <= 6.4.3
#                       6.5 <= version <= 6.5.1
VULNERABLE_VERSIONS = [
    r"6\.0(\.[1-7])?",
    r"6\.1(\.[1-5])?",
    r"6\.2(\.[1-4])?",
    r"6\.3(\.[1-3])?",
    r"6\.4(\.[1-3])?",
    r"6\.5(\.1)?",
]
VULNERABILITY_TITLE = (
    "Unauthenticated Stored Cross-Site Scripting Vulnerability in WordPress Core"
)
VULNERABILITY_REFERENCE = "CVE-2024-4439"
VULNERABILITY_DESCRIPTION = (
    "WordPress Core is vulnerable to Stored Cross-Site Scripting via user display "
    "names in the Avatar block in various versions up to 6.5.2 due to insufficient output escaping on the display name."
)
RISK_RATING = "CRITICAL"


@exploits_registry.register
class CVE20244439Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/")
    check_request = definitions.Request(method="GET", path="/")
    accept_pattern = [re.compile("WordPress")]
    match_pattern = [
        re.compile(f'<meta name="generator" content="WordPress {version}">')
        for version in VULNERABLE_VERSIONS
    ]

    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
        cve_ids=["CVE-2024-4439"],
    )
