"""Agent Asteroid implementation for CVE-2024-38077"""

import logging
import socket

from impacket.dcerpc.v5 import transport, epm  # type: ignore
from impacket.dcerpc.v5 import ndr, dtypes, rpcrt
from impacket import uuid  # type: ignore
from ostorlab.agent.kb import kb
from ostorlab.agent.mixins import agent_report_vulnerability_mixin

from agent import definitions
from agent import exploits_registry

UUID = uuid.uuidtup_to_bin(("3d267954-eeb7-11d1-b94e-00c04fa3080d", "1.0"))
AUTH_LEVEL = 2
TIMEOUT = 30
ALIGNMENT = 4
VULNERABILITY_TITLE = "Windows Remote Desktop Licensing Service RCE"
VULNERABILITY_REFERENCE = "CVE-2024-38077"
VULNERABILITY_DESCRIPTION = (
    "The Windows Remote Desktop Licensing Service is vulnerable to an RCE. Attackers can "
    "trigger a buffer overflow, leading to arbitrary code execution within the context of the RDL service"
)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class ContextHandle(ndr.NDRSTRUCT):  # type: ignore
    """Represents the context handle structure used in RPC calls."""

    structure = (("Data", "20s=b"),)

    def getAlignment(self) -> int:
        """Returns the alignment value for the structure."""
        return ALIGNMENT


class TLSRpcGetVersion(ndr.NDRCALL):  # type: ignore
    """Represents the RPC call to get the version of the RDL service."""

    opnum = 0
    structure = (
        ("ctx_handle", ContextHandle),
        ("version", dtypes.PULONG),
    )


class TLSRpcConnect(ndr.NDRCALL):  # type: ignore
    """Represents the RPC call to establish a connection to the RDL service."""

    opnum = 1


class TLSRpcConnectResponse(ndr.NDRCALL):  # type: ignore
    """Represents the response to the TLSRpcConnect RPC call."""

    structure = (("ctx_handle", ContextHandle),)


def _connect_to_license_server(target_ip: str) -> str | None:
    """Connects to the target RDL service and attempts to retrieve the version.

    Args:
        target_ip (str): The IP address of the target.

    Returns:
        str | None: The version of the RDL service as a hexadecimal string, or None if the connection fails.
    """
    try:
        stringbinding = epm.hept_map(target_ip, UUID, protocol="ncacn_ip_tcp")
        logger.info("RPC Binding String: %s", stringbinding)
        rpctransport = transport.DCERPCTransportFactory(stringbinding)
        rpctransport.set_connect_timeout(TIMEOUT)
        dce = rpctransport.get_dce_rpc()
        dce.set_auth_level(AUTH_LEVEL)
        dce.connect()
        dce.bind(UUID)

        rpc_conn = TLSRpcConnect()
        res_rpc_conn = dce.request(rpc_conn)
        ctx_handle = res_rpc_conn["ctx_handle"]

        get_version = TLSRpcGetVersion()
        get_version["ctx_handle"] = ctx_handle
        get_version["version"] = 3
        res_get_version = dce.request(get_version)
        version = res_get_version["version"]
        return "0x{:x}".format(version)

    except (rpcrt.DCERPCException, socket.gaierror) as e:
        logger.error("Failed to connect or get version: %s", e)
        return None


def _create_vulnerability(target: definitions.Target) -> definitions.Vulnerability:
    """Creates a vulnerability entry if the target is found to be vulnerable.

    Args:
        target (definitions.Target): The target to create the vulnerability entry for.

    Returns:
        definitions.Vulnerability: A vulnerability entry object.
    """
    entry = kb.Entry(
        title=VULNERABILITY_TITLE,
        risk_rating="HIGH",
        short_description=VULNERABILITY_DESCRIPTION,
        description=VULNERABILITY_DESCRIPTION,
        references={
            "nvd.nist.gov": f"https://nvd.nist.gov/vuln/detail/{VULNERABILITY_REFERENCE}",
        },
        recommendation=(
            "- Apply security patches from Microsoft if available.\n"
            "- Restrict access to the licensing service.\n"
            "- Monitor for unusual activities."
        ),
        security_issue=True,
        privacy_issue=False,
        has_public_exploit=False,
        targeted_by_malware=False,
        targeted_by_ransomware=False,
        targeted_by_nation_state=False,
    )
    technical_detail = (
        f"{target.origin} is vulnerable to {VULNERABILITY_REFERENCE}: "
        f"{VULNERABILITY_TITLE}"
    )
    return definitions.Vulnerability(
        entry=entry,
        technical_detail=technical_detail,
        risk_rating=agent_report_vulnerability_mixin.RiskRating.HIGH,
    )


@exploits_registry.register
class WindowsRDLServiceExploit(definitions.Exploit):
    """Main class for detecting the CVE-2024-38077 vulnerability."""

    def accept(self, target: definitions.Target) -> bool:
        """Checks if the target is likely vulnerable by attempting to connect.

        Args:
            target (definitions.Target): The target to check.

        Returns:
            bool: True if the target is likely vulnerable, False otherwise.
        """
        return _connect_to_license_server(target.origin) is not None

    def check(self, target: definitions.Target) -> list[definitions.Vulnerability]:
        """Performs a full check to confirm the vulnerability.

        Args:
            target (definitions.Target): The target to check.

        Returns:
            list[definitions.Vulnerability]: A list of vulnerabilities found on the target.
        """
        vulnerabilities = []
        version = _connect_to_license_server(target.origin)
        if version is not None:
            vulnerabilities.append(_create_vulnerability(target))
        return vulnerabilities
