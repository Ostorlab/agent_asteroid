"""Agent Asteroid implementation for CVE-2023-45727"""

import re

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VULNERABILITY_TITLE = "Proself Enterprise/Standard XXE Vulnerability"
VULNERABILITY_REFERENCE = "CVE-2023-45727"
VULNERABILITY_DESCRIPTION = (
    "An XML External Entity (XXE) vulnerability exists in Proself Enterprise/Standard Edition Ver5.62 and earlier, "
    "Proself Gateway Edition Ver1.65 and earlier, and Proself Mail Sanitize Edition Ver1.08 and earlier. "
    "A remote unauthenticated attacker may exploit this issue by sending a specially crafted request with malformed "
    "XML data, allowing the reading of arbitrary files on the server, including those containing sensitive account "
    "information."
)
RISK_RATING = "CRITICAL"
ACCEPT_PATTERN = [re.compile(r"<title>\s*Proself.*Login\s*</title>")]
MATCH_PATTERN = [
    re.compile(r"Proself Ver\.3"),
    re.compile(r"Proself Ver\.2"),
    re.compile(r"Proself Ver\.4"),
]


@exploits_registry.register
class CVE202345727Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(
        method="GET", path="/proself/login/login.go?AD=init"
    )
    check_request = definitions.Request(
        method="POST", path="/proself/login/login.go?AD=init"
    )
    accept_pattern = ACCEPT_PATTERN
    match_pattern = MATCH_PATTERN
    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
        cve_ids=["CVE-2023-45727"],
    )
