"""Agent Asteroid implementation for CVE-2024-11205"""

import re

from packaging import version

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VERSION_PATTERN = re.compile(r"Stable tag:\s(\d+\.\d+(?:\.\d+)*)")
MAX_VULNERABLE_VERSION = version.parse("1.9.2.1")
MIN_VULNERABLE_VERSION = version.parse("1.8.4")
VULNERABILITY_TITLE = (
    "WPForms Lite Plugin 1.8.4 - 1.9.2.1 - Missing Authorization to Authenticated "
    "(Subscriber+) Payment Refund and Subscription Cancellation"
)
VULNERABILITY_REFERENCE = "CVE-2024-11205"
VULNERABILITY_DESCRIPTION = (
    "The WPForms Lite plugin for WordPress is vulnerable to unauthorized modification "
    "of data due to a missing capability check on the 'wpforms_is_admin_page' function "
    "in versions starting from 1.8.4 up to, and including, 1.9.2.1. This makes it "
    "possible for authenticated attackers, with Subscriber-level access and above, to "
    "refund payments and cancel subscriptions."
)
RISK_RATING = "HIGH"


@exploits_registry.register
class CVE202411205Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(
        method="GET", path="/wp-content/plugins/wpforms-lite/readme.txt"
    )
    check_request = definitions.Request(
        method="GET", path="/wp-content/plugins/wpforms-lite/readme.txt"
    )
    accept_pattern = [
        re.compile("Contact Form by WPForms - Drag & Drop Form Builder for WordPress")
    ]
    version_pattern = VERSION_PATTERN
    vuln_ranges = [
        definitions.VulnRange(MIN_VULNERABLE_VERSION, MAX_VULNERABLE_VERSION)
    ]

    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
        cve_ids=["CVE-2024-11205"],
    )
