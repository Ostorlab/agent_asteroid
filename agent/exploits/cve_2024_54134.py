"""Agent Asteroid implementation for CVE-2024-54134"""

import re

from packaging import version

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VULNERABILITY_TITLE = "MALICIOUS PACKAGES FOUND IN COMPROMISED @SOLANA/WEB3.JS LIBRARY"
VULNERABILITY_REFERENCE = "CVE-2024-54134"
VULNERABILITY_DESCRIPTION = """A compromised publish-access account for the @solana/web3.js library allowed attackers to release malicious packages (versions 1.95.6 and 1.95.7).
These packages were modified to steal private key material, potentially draining funds from affected Solana dapps that handle private keys directly"""
RISK_RATING = "HIGH"
MIN_VULNERABLE_VERSION = version.parse("1.95.6")
MAX_VULNERABLE_VERSION = version.parse("1.95.7")
VERSION_PATTERN = re.compile(r"@solana/web3\.js@(\d+\.\d+\.\d+)")


@exploits_registry.register
class CVE202454134Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/")
    check_request = definitions.Request(method="GET", path="/")
    accept_pattern = [re.compile("https://unpkg\.com/@solana/web3\.js")]
    vuln_ranges = [
        definitions.VulnRange(MIN_VULNERABLE_VERSION, MAX_VULNERABLE_VERSION)
    ]
    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
    )
    version_pattern = VERSION_PATTERN
