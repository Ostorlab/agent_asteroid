"""Agent Asteroid implementation for CVE-2024-39717"""

import re

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit


VULNERABILITY_TITLE = "Versa Director Dangerous File Type Upload Vulnerability"
VULNERABILITY_REFERENCE = "CVE-2024-39717"
VULNERABILITY_DESCRIPTION = (
    "The Versa Director GUI provides an option to customize the look and feel of the user interface. "
    "This option is only available for a user logged with Provider-Data-Center-Admin or Provider-Data-Center-System-Admin. "
    "(Tenant level users do not have this privilege). The “Change Favicon” (Favorite Icon) option can be mis-used to upload a "
    "malicious file ending with .png extension to masquerade as image file. This is possible only after a user with "
    "Provider-Data-Center-Admin or Provider-Data-Center-System-Admin has successfully authenticated and logged in."
)
RISK_RATING = "CRITICAL"


@exploits_registry.register
class CVE202439717Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/versa/login")
    check_request = definitions.Request(method="GET", path="/versa/login")
    accept_pattern = [re.compile("Versa Director")]
    match_pattern = [re.compile("20([0-1][0-9]|2[0-3])\s*Versa Networks")]

    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
    )
