"""Agent Asteroid implementation for CVE-2024-55956"""

import re

from packaging import version

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VERSION_PATTERN = re.compile(
    r"(?:VLTrader|Harmony|LexiCom)/((?:[0-4](?:\.\d+){0,3})|5(?:\.[0-7](?:\.\d{1,2}){0,2})?|5\.8(?:\.0(?:\.(?:0|[1-9]|1[0-9]|2[0-3]))?)?)\s*\("
)
MAX_VULNERABLE_VERSION = version.parse("5.8.0.23")
MIN_VULNERABLE_VERSION = version.parse("0.0.0")
VULNERABILITY_TITLE = "Cleo Harmony, VLTrader, and LexiCom - Arbitrary Command Execution via Autorun Directory"
VULNERABILITY_REFERENCE = "CVE-2024-55956"
VULNERABILITY_DESCRIPTION = (
    "In Cleo Harmony before 5.8.0.24, VLTrader before 5.8.0.24, and LexiCom before "
    "5.8.0.24, an unauthenticated user can import and execute arbitrary Bash or PowerShell "
    "commands on the host system by leveraging the default settings of the Autorun directory."
)
RISK_RATING = "CRITICAL"


@exploits_registry.register
class CVE202455956Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/")
    check_request = definitions.Request(method="GET", path="/")
    accept_pattern = [re.compile(r"Cleo (VLTrader|Harmony|LexiCom)/[\d.]+")]
    version_pattern = VERSION_PATTERN
    vuln_ranges = [
        definitions.VulnRange(MIN_VULNERABLE_VERSION, MAX_VULNERABLE_VERSION)
    ]

    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
        cve_ids=["CVE-2024-55956"],
    )
