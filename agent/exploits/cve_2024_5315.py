"""Agent Asteroid implementation for CVE-2024-5315"""

import re

from packaging import version
from agent.exploits import webexploit

from agent import definitions
from agent import exploits_registry

VULNERABILITY_TITLE = "Dolibarr ERP-CRM 9.0.1 - SQL Injection"
VULNERABILITY_REFERENCE = "CVE-2024-5315"
VULNERABILITY_DESCRIPTION = (
    "SQL injection vulnerability in Dolibarr ERP-CRM 9.0.1 via the 'viewstatut' parameter in the /dolibarr/commande/list.php script. "
    "The vulnerability allows remote attackers to send specially crafted SQL queries and retrieve all information stored in the database."
)

RISK_RATING = "CRITICAL"
MAX_VULNERABLE_VERSION = version.parse("10.0.7")
VERSION_PATTERN = re.compile(r"@ (\d+\.\d+\.\d)+</title>")


@exploits_registry.register
class CVE20245315Exploit(webexploit.WebExploit):
    """
    CVE-2024-5315: Dolibarr ERP-CRM 9.0.1 - SQL Injection
    """

    accept_request = definitions.Request(method="GET", path="/")
    check_request = definitions.Request(method="GET", path="/")
    accept_pattern = [re.compile("<title>(Identifiant|Login) @ \d+\.\d+\.\d+</title>")]
    vuln_ranges = [definitions.VulnRange(None, MAX_VULNERABLE_VERSION)]
    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
        cve_ids=["CVE-2024-5315"],
    )
    version_pattern = VERSION_PATTERN
