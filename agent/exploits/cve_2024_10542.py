"""Agent Asteroid implementation for CVE-2024-10542"""

import re

from packaging import version

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VERSION_PATTERN = re.compile(r"Stable tag:\s(\d+\.\d+(?:\.\d+)?)")
MAX_VULNERABLE_VERSION = version.parse("6.43.2")
VULNERABILITY_TITLE = (
    "CleanTalk Plugin Arbitrary Plugin Installation (Via Reverse DNS Spoofing)"
)
VULNERABILITY_REFERENCE = "CVE-2024-10542"
VULNERABILITY_DESCRIPTION = (
    "The Spam protection, Anti-Spam, FireWall by CleanTalk plugin for WordPress "
    "is vulnerable to unauthorized Arbitrary Plugin Installation due to an authorization bypass "
    "via reverse DNS spoofing on the checkWithoutToken function in all versions up to, and including, 6.43.2. "
    "This allows unauthenticated attackers to install and activate arbitrary plugins, "
    "potentially leading to remote code execution if another vulnerable plugin is installed."
)
RISK_RATING = "HIGH"


@exploits_registry.register
class CVE202410542Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(
        method="GET", path="/wp-content/plugins/cleantalk-spam-protect/readme.txt"
    )
    check_request = definitions.Request(
        method="GET", path="/wp-content/plugins/cleantalk-spam-protect/readme.txt"
    )
    accept_pattern = [re.compile("Spam protection, Anti-Spam, FireWall by CleanTalk")]
    version_pattern = VERSION_PATTERN
    vuln_ranges = [definitions.VulnRange(None, MAX_VULNERABLE_VERSION)]

    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
    )
