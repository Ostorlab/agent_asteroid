"""Agent Asteroid implementation for CVE-2024-6386"""

import re

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

# Multiline mode flag
MULTILINE_FLAG = r"(?m)"
# Match the beginning of the line and "Stable tag:" text
STABLE_TAG_PREFIX = r"^Stable tag:\s+"
# Match versions 0.x.x, 1.x.x, 2.x.x, 3.x.x
VERSIONS_0_TO_3 = r"0|[1-3](?:\.\d+){0,2}"
# Match versions 4.0.x to 4.5.x
VERSIONS_4_0_TO_4_5 = r"4(?:\.(?:[0-5](?:\.\d+)?)?)?"
# Match versions 4.6.0 to 4.6.12
VERSIONS_4_6_0_TO_4_6_12 = r"4\.6(?:\.(?:[0-9]|1[0-2]))?"
# Combine all version patterns
ALL_VERSIONS = f"({VERSIONS_0_TO_3}|{VERSIONS_4_0_TO_4_5}|{VERSIONS_4_6_0_TO_4_6_12})"
# Match the end of the line
END_OF_LINE = r"$"
# Combine all parts into the final regex
VULNERABLE_VERSIONS_REGEX = (
    f"{MULTILINE_FLAG}{STABLE_TAG_PREFIX}{ALL_VERSIONS}{END_OF_LINE}"
)
VULNERABILITY_TITLE = "WPML Multilingual CMS Authenticated Contributor+ Remote Code Execution (RCE) via Twig Server-Side Template Injection (SSTI)"
VULNERABILITY_REFERENCE = "CVE-2024-6386"
VULNERABILITY_DESCRIPTION = (
    "The WPML Multilingual CMS Plugin for WordPress used by over 1 million sites is susceptible to an Authenticated ("
    "Contributor+) Remote Code Execution (RCE) vulnerability through a Twig server-side template injection."
)
RISK_RATING = "CRITICAL"


@exploits_registry.register
class CVE20246386Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(
        method="GET", path="/wp-content/plugins/sitepress-multilingual-cms/readme.txt"
    )
    check_request = definitions.Request(
        method="GET", path="/wp-content/plugins/sitepress-multilingual-cms/readme.txt"
    )
    accept_pattern = [re.compile("SitePress Multilingual CMS")]
    match_pattern = [re.compile(VULNERABLE_VERSIONS_REGEX)]

    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
    )
