"""Agent Asteroid implementation for CVE-2024-6386"""

import re

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VULNERABLE_VERSIONS_REGEX = r"(?m)^Stable tag:\s+(0|[1-3](?:\.\d+){0,2}|4(?:\.(?:[0-5](?:\.\d+)?|6(?:\.(?:[0-9]|1[0-2]))?)?)?)$"
VULNERABILITY_TITLE = "WPML Multilingual CMS Authenticated Contributor+ Remote Code Execution (RCE) via Twig Server-Side Template Injection (SSTI)"
VULNERABILITY_REFERENCE = "CVE-2024-6386"
VULNERABILITY_DESCRIPTION = (
    "The WPML Multilingual CMS Plugin for WordPress used by over 1 million sites is susceptible to an Authenticated ("
    "Contributor+) Remote Code Execution (RCE) vulnerability through a Twig server-side template injection."
)
RISK_RATING = "CRITICAL"


@exploits_registry.register
class CVE20246386Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(
        method="GET", path="/wp-content/plugins/sitepress-multilingual-cms/readme.txt"
    )
    check_request = definitions.Request(
        method="GET", path="/wp-content/plugins/sitepress-multilingual-cms/readme.txt"
    )
    accept_pattern = [re.compile("SitePress Multilingual CMS")]
    match_pattern = [re.compile(VULNERABLE_VERSIONS_REGEX)]

    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
    )
