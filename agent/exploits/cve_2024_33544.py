"""Agent Asteroid implementation for CVE-2024-33544"""

import re

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VULNERABLE_VERSIONS = [
    r"(1[0-3]|\d)(\.\d+){0,2}\n",  # Matches versions from 1.0 to 13.x.x
    r"14\.0(\.[0-9]|\.10)\n",  # Matches versions from 14.0.0 to 14.0.10
]
VULNERABILITY_TITLE = "Unauthenticated SQL Injection Vulnerability in WZone Plugin"
VULNERABILITY_REFERENCE = "CVE-2024-33544"
VULNERABILITY_DESCRIPTION = (
    "The WZone plugin for WordPress is vulnerable to SQL Injection in versions up to 14.0.10, "
    "allowing unauthenticated attackers to execute arbitrary SQL commands on the database."
)
RISK_RATING = "HIGH"


@exploits_registry.register
class CVE202433544Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(
        method="GET", path="/wp-content/plugins/wzone/readme.txt"
    )
    check_request = definitions.Request(
        method="GET", path="/wp-content/plugins/wzone/readme.txt"
    )
    accept_pattern = [re.compile("WZone")]
    match_pattern = [
        re.compile(f"Stable tag: {version}") for version in VULNERABLE_VERSIONS
    ]

    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
        cve_ids=["CVE-2024-33544"],
    )
