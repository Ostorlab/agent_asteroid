"""Agent Asteroid implementation for CVE-2024-6385"""

import re
from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VULNERABILITY_TITLE = "GitLab Authentication Bypass Vulnerability."
VULNERABILITY_REFERENCE = "CVE-2024-6385"
VULNERABILITY_DESCRIPTION = (
    "An issue was discovered in GitLab CE/EE affecting all versions starting "
    "from 15.8 prior to 16.11.6, starting from 17.0 prior to 17.0.4, "
    "and starting from 17.1 prior to 17.1.2, which allows an attacker "
    "to trigger a pipeline as another user under certain circumstances."
)
RISK_RATING = "POTENTIALLY"

VERSIONS_HASHES = [
    "abd1002d017cf458a22594e9eebc44f159b87466d62ff38da0a4364e1c486007",
    "f6b592d2e7570ce5d28f3dbf7170c0b3aa19dcb951f8c9e9ebe6cd5ec44691e8",
    "c2e2e19b4ed75b3c7745158c2cccd4f82baa0ea853cd1688965c0e6865aa4fe3",
    "c19a43b56f2b869d14e8b8865f2673e99e95a3f9912c95776e2aa44d0de56416",
    "971982e3e67f5419507bf8034fc7ae9754f607a4f0e6a7483cd7d579936d0a43",
    "e7b1efce983de69e755cecf958ad52fe9c578fee502ec2046fbe4d418e12c237",
    "ba1723ee38768ca6dcce3e345b1f4cef7372520f2adbb0b5be32a0e6a2b6d5df",
    "a727ffdf1055442288d2fbc8b2ab23c38185697594725ea899f9faa653fad748",
    "77ee44de16d2f31b4ddfd214b60b6327fe48b92df7054b1fb928fd6d4439fc7e",
    "fb3d9b8e0a1937690eb35bd8b7a8686b51f36226bc9c29f0ea1621d568030c1a",
    "bada36d178d3db075d85c6e2bf2a094b8519c2551d4569a2c2cb8b5b2b07247c",
    "ad779fabb121ac9d0c594b996d2fddb1fee9ce36c886c73c3d0e6fe10233819b",
    "7dc3e992d5cc9567299c4981b2de6be6a12ae7c78bb9535d5485b0239c3b3f14",
    "106174ae025caa47e54ebda6fb32a305a86857c1a808ab1a76a697e8a286166c",
    "dee053ee9a9f14f8790cb0ac27bfaf6279e364d5219b9637f1c05049e1da038e",
    "198963a1fcb2babf24b04c7c3a57fe439f453a90e1820ef7228d23a420b137ec",
    "b35365c3f2d60a068185eacd7e836e1f173c0c4eb3af308fd388f1b84db673b4",
    "6687cea99d08705f41c22ba6c0f625668940d80a47e99488bf0d3d4bafa9d398",
    "8ebfa16265f86eb24ceda740b31d44d2e5d86ceb9fba74eb308f08e1f99ccaa8",
    "1d30846db8d63a25cb7d1a54a8ef11af9382c4d5e95fcc6ba7c8f34f9581d51d",
    "cfc4d03e10ba8e1d144a4508f036f477fa5281690eca7258d5ef069d98614b41",
    "c10b409df4222d166bfe9b34b787e05a671f9116b47ee10265029bfda6c5305b",
    "e803bb812a5c601a017cbfaa6d442b51c869a084d04a0e2b77dfee19959bc000",
    "f79ed5a6b0dfecf39281aeefcdd5b15d7cc6d871a3ae20e60c40d6a718377704",
    "deeef002fddf6f74357454676107b4ec50cf51f70394f2368f404683f1884132",
    "7649badc780fc4e44c1b7063c6153b3c216a5f6f0d7907eed714fac2a39ede73",
    "45a1c5dcac6ab55c1b924c47992ed649a5ac98e55dfc62e0d65b178128020aca",
    "47ec6054e1998d4cb2623b09faa02993de5f7cc92d34ba60dad2646b3b92a83e",
    "8e1fac7546e10d24ab7482b66e2863732a6795cce85e9ff10d8bfd59cad1cd9f",
    "e357f1b1a6812a8e72a4aec06b3761062a281129d621bf2e580806a8fca6302d",
    "9412070de1081bd15748e4c0278a95f4b9b50ad910d97e8004582321e45a8858",
    "aecafb937628c9745dc285b2cb2c41d8a57846c934c2168b0cfec35b3d44e51f",
    "9723ad2290324a6ed951c5d4b011743f27afa0b6450cb147a63587b67b70985a",
    "73616daa0479bf77369c603146e745cc4cb9874b3b38f81fb2993818049dbf1a",
    "d406cd866e79675515e2467e3b3c1c79bc380bee4d9c30de803b870a26af53cd",
    "58ebcd8f96ecc2ebf7f29122395e38ee28dc833dfc6d08fb667d2655da971df6",
    "539db0d62ee9e10949bac79127c082aaa0e8d001ddda9467cd8a1d05928a9b8b",
    "05a4322b27a3352f9638610b6a2528a03f90070a19fdb9e0499bb0412aad92fb",
    "f26176d736b2c98959127f2c53a94ba4c3c060368eb6797ad06dd923012b53bd",
    "1b91aa4fc5e5ae49577087b2b42821ac87b863ba4de61cdccdd6b3620f587608",
    "bc8000290bc8c8c0ebadb5c9d96dac50df8244426ef375a23cfae334e9b100c2",
    "64ec030272495820a69a90e76affc1d0c47377c80f267ed21fa039c40404d4c9",
]


@exploits_registry.register
class CVE20242879Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/users/sign_in")
    check_request = definitions.Request(method="GET", path="/users/sign_in")
    accept_pattern = [re.compile("GitLab")]
    match_pattern = [re.compile(version) for version in VERSIONS_HASHES]

    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
    )
