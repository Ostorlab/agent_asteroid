"""Agent Asteroid implementation for CVE-2024-2879"""

import re
from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VULNERABILITY_TITLE = "LayerSlider 7.9.11 - 7.10.0 - Unauthenticated SQL Injection"
VULNERABILITY_REFERENCE = "CVE-2024-2879"
VULNERABILITY_DESCRIPTION = (
    "The LayerSlider plugin for WordPress is vulnerable to SQL Injection via the ls_get_popup_markup action in "
    "versions 7.9.11 and 7.10.0 due to insufficient escaping on the user supplied parameter and lack of sufficient "
    "preparation on the existing SQL query. This makes it possible for unauthenticated attackers to append additional "
    "SQL queries into already existing queries that can be used to extract sensitive information from the database."
)
RISK_RATING = "CRITICAL"


@exploits_registry.register
class CVE20242879Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/")
    check_request = definitions.Request(method="GET", path="/")
    accept_pattern = re.compile("/wp-content/plugins/LayerSlider/")
    match_pattern = re.compile("layerslider\/css\/layerslider.css\?ver=(7.9.11|7.10.0)")
    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
    )
