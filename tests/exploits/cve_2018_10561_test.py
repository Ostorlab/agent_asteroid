"""Unit tests for Agent Asteriod exploits"""

import requests_mock as req_mock


from agent import definitions
from agent.exploits import cve_2018_10561


def testCVE_2021_22941_whenVulnerable_reportFinding(
    requests_mock: req_mock.mocker.Mocker,
) -> None:
    """Unit test for CVE-2021-22941, case when target is vulnerable"""
    target = definitions.Target(scheme="https", host="75.162.65.52", port=443)
    exploit_instance = cve_2018_10561.CVE201810562Exploit()
    requests_mock.post("https://75.162.65.52/GponForm/diag_Form?images/")
    requests_mock.get(
        "https://75.162.65.52/diag.html?images/",
        text="diag_result = test2.txt\ntest3.txt",
    )

    vulnerabilities = exploit_instance.check(target)

    assert len(vulnerabilities) > 0
    vulnerability = vulnerabilities[0]

    assert (
        vulnerability.entry.title
        == "Dasan GPON Routers Command Injection Vulnerability"
    )
    assert vulnerability.technical_detail == (
        "https://75.162.65.52 is vulnerable to CVE-2018-10562, Dasan GPON Routers "
        "Command Injection Vulnerability.\n"
        "```\n"
        "diag_result = test2.txt\n"
        "test3.txt\n"
        "```\n"
    )
