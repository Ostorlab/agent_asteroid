"""Unit tests for Agent Asteroid: CVE-2018-13382"""

import requests_mock as req_mock

from agent import definitions
from agent.exploits import cve_2018_13382


def testCVE201813382_whenVulnerable_reportFinding(
    requests_mock: req_mock.mocker.Mocker,
) -> None:
    """Ensure that the exploit reports findings when the application is vulnerable."""
    exploit_instance = cve_2018_13382.CVE201813382Exploit()
    url = "https://109.239.246.106:10443/remote/login?lang=en"
    requests_mock.post(
        url,
        text="redir=/remote/hostcheck_install",
        status_code=200,
    )
    target = definitions.Target("https", "109.239.246.106", 10443)

    vulnerabilities = exploit_instance.check(target)

    vulnerability = vulnerabilities[0]
    assert (
        vulnerability.entry.title
        == "An Improper Authorization vulnerability in Fortinet FortiOS: CVE-2018-13382"
    )
    assert (
        vulnerability.technical_detail
        == "https://109.239.246.106:10443/ is vulnerable to CVE-2018-13382 : "
        "the admin user's password being changed to `ChangePassword`."
    )


def testCVE201813382_whenNotVulnerable_noFindingsReported(
    requests_mock: req_mock.mocker.Mocker,
) -> None:
    """Ensure that there is no findings when the application is not vulnerable."""
    exploit_instance = cve_2018_13382.CVE201813382Exploit()
    url = "https://139.255.255.218:10443/remote/login?lang=en"
    requests_mock.post(
        url,
        text="",
        status_code=200,
    )
    target = definitions.Target("https", "139.255.255.218", 10443)

    vulnerabilities = exploit_instance.check(target)

    assert len(vulnerabilities) == 0
