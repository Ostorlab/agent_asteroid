import re
import requests_mock as req_mock

from agent import definitions
from agent.exploits import cve_2024_6387


def create_target(scheme: str, domain: str, port: int) -> definitions.Target:
    """Helper function to create a Target instance."""
    return definitions.Target(scheme, f"{scheme}://{domain}:{port}", port, "")


def testOpenSSHExploit_whenVulnerable_reportFinding(
    requests_mock: req_mock.mocker.Mocker,
) -> None:
    exploit_instance = cve_2024_6387.OpenSSHExploit()

    vulnerable_domains = ["45.238.2.13"]

    for domain in vulnerable_domains:
        requests_mock.get(
            re.compile(f"{domain}"),
            text="<html><title>OpenSSH</title></html>",
            status_code=200,
            headers={"Server": "SSH-2.0-OpenSSH_8.9p1"},
        )

        target = create_target("ssh", domain, 22)

        accept = exploit_instance.accept(target)
        assert accept, f"Expected vulnerability detection for IP address {domain}, but accept returned False"


def testOpenSSHExploit_whenSafe_reportNothing(
    requests_mock: req_mock.mocker.Mocker,
) -> None:
    exploit_instance = cve_2024_6387.OpenSSHExploit()

    safe_domains = ["45.224.115.234"]

    for domain in safe_domains:
        requests_mock.get(
            re.compile(f"{domain}"),
            text="<html><title>OpenSSH</title></html>",
            status_code=200,
            headers={"Server": "SSH-2.0-OpenSSH_7.4p1"},
        )

        target = create_target("ssh", domain, 22)

        accept = exploit_instance.accept(target)
        assert not accept, f"Expected no vulnerability detection for domain {domain}, but accept returned True"

        vulnerabilities = exploit_instance.check(target)
        assert (
            len(vulnerabilities) == 0
        ), f"Expected no vulnerabilities for domain {domain}, but found {len(vulnerabilities)}"
