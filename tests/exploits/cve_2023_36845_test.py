"""Unit tests for CVE-2023-36845"""
import requests_mock as req_mock
from agent.exploits import cve_2023_36845
from agent import definitions


def testCVE202336845_whenVulnerable_reportFinding(
    requests_mock: req_mock.mocker.Mocker,
) -> None:
    """Unit test for CVE-2023-36845, case when target is vulnerable."""
    target = definitions.Target(scheme="http", host="127.0.0.1", port=8080)
    exploit_instance = cve_2023_36845.CVE202336845Exploit()
    requests_mock.post(
        "http://127.0.0.1:8080/",
        content=b"""root:*:0:0:Charlie &:/root:/bin/csh
                daemon:*:1:1:Owner of many system processes:/root:/sbin/nologin
                operator:*:2:5:System &:/:/sbin/nologin
                tty:*:4:65533:Tty Sandbox:/:/sbin/nologin
                kmem:*:5:65533:KMem Sandbox:/:/sbin/nologin
                sshd:*:22:22:Secure Shell Daemon:/var/empty:/sbin/nologin
                ext:*:39:39:External applications:/:/sbin/nologin
                bind:*:53:53:Bind Sandbox:/:/sbin/nologin
                uucp:*:66:66:UUCP pseudo-user:/var/spool/uucppublic:/sbin/nologin
                nobody:*:65534:65534:Unprivileged user:/nonexistent:/sbin/nologin
                33768:*:100:20::/var/home/33768:/usr/sbin/cli
                jforce:*:2000:20::/var/home/jforce:/usr/sbin/cli
                jmay:*:2001:20::/var/home/jmay:/usr/sbin/cli
                <html>page();</html>""",
    )

    vulnerabilities = exploit_instance.check(target)
    vulnerability = vulnerabilities[0]

    assert (
        vulnerability.entry.title
        == "Juniper Junos OS EX Series and SRX Series PHP External Variable Modification Vulnerability"
    )
    assert vulnerability.technical_detail == (
        "http://127.0.0.1:8080/ is vulnerable to CVE-2023â€“36845, Juniper Junos OS "
        "EX Series and SRX Series PHP External Variable Modification Vulnerability"
    )
    assert vulnerability.risk_rating.name == "CRITICAL"


def testCVE202336845_whenSafe_reportNothing(
    requests_mock: req_mock.mocker.Mocker,
) -> None:
    """Unit test for CVE-2023-36845, case when target is safe."""
    target = definitions.Target(scheme="http", host="127.0.0.1", port=8080)
    exploit_instance = cve_2023_36845.CVE202336845Exploit()
    requests_mock.post(
        "http://127.0.0.1:8080/",
        content=b"JUNIPER VPN LOGIN",
    )

    vulnerabilities = exploit_instance.check(target)

    assert len(vulnerabilities) == 0
