"""Unit tests for Agent Asteroid: CVE-2024-6633"""

from unittest import mock
import jaydebeapi  # type: ignore

from agent import definitions
from agent.exploits import cve_2024_6633


def testAccept_whenPortIsOpen_reportTrue() -> None:
    """Test the accept method when the target port is open."""
    with mock.patch("agent.exploits.cve_2024_6633._is_port_open", return_value=True):
        exploit_instance = cve_2024_6633.CVE20246633Exploit()
        target = definitions.Target("tcp", "192.168.1.1", 4406)
        assert exploit_instance.accept(target) is True


def testAccept_whenPortIsClosed_reportFalse() -> None:
    """Test the accept method when the target port is closed."""
    with mock.patch("agent.exploits.cve_2024_6633._is_port_open", return_value=False):
        exploit_instance = cve_2024_6633.CVE20246633Exploit()
        target = definitions.Target("tcp", "192.168.1.1", 4406)
        assert exploit_instance.accept(target) is False


def testCheck_whenVulnerable_reportFinding() -> None:
    """Test the check method when a vulnerability is found."""
    with mock.patch(
        "agent.exploits.cve_2024_6633._detect_vulnerability", return_value=True
    ):
        exploit_instance = cve_2024_6633.CVE20246633Exploit()
        target = definitions.Target("tcp", "192.168.1.1", 4406)
        vulnerabilities = exploit_instance.check(target)
        assert len(vulnerabilities) == 1
        assert (
            vulnerabilities[0].entry.title
            == "Default Credentials in Fortra FileCatalyst Workflow HSQLDB"
        )


def testCheck_whenNotVulnerable_reportNothing() -> None:
    """Test the check method when no vulnerability is found."""
    with mock.patch(
        "agent.exploits.cve_2024_6633._detect_vulnerability", return_value=False
    ):
        exploit_instance = cve_2024_6633.CVE20246633Exploit()
        target = definitions.Target("tcp", "192.168.1.1", 4406)
        vulnerabilities = exploit_instance.check(target)
        assert len(vulnerabilities) == 0


@mock.patch("agent.exploits.cve_2024_6633.socket.socket")
def testIsPortOpen_whenPortIsOpen_reportTrue(mock_socket: mock.MagicMock) -> None:
    """Test _is_port_open when the port is open."""
    mock_socket_instance = mock_socket.return_value
    mock_socket_instance.connect_ex.return_value = 0  # Simulate port being open

    result = cve_2024_6633._is_port_open("192.168.1.1", 4406)

    assert (
        result is True
    ), f"Expected True, but got {result}. The port should be reported as open."


@mock.patch("agent.exploits.cve_2024_6633.socket.socket")
def testIsPortOpen_whenPortIsClosed_reportFalse(mock_socket: mock.MagicMock) -> None:
    """Test _is_port_open when the port is closed."""
    mock_socket_instance = mock_socket.return_value
    mock_socket_instance.connect_ex.return_value = 1  # Simulate port being closed

    result = cve_2024_6633._is_port_open("192.168.1.1", 4406)

    assert (
        result is False
    ), f"Expected False, but got {result}. The port should be reported as closed."


@mock.patch("agent.exploits.cve_2024_6633.jaydebeapi.connect")
def testAttemptDbConnection_whenSuccessful_reportTrue(
    mock_connect: mock.MagicMock,
) -> None:
    """Test _attempt_db_connection when the connection is successful."""
    mock_conn = mock.MagicMock()
    mock_connect.return_value = mock_conn

    result = cve_2024_6633._attempt_db_connection("192.168.1.1", 9001)

    assert result is True
    mock_conn.close.assert_called_once()


@mock.patch("agent.exploits.cve_2024_6633.jaydebeapi.connect")
def testAttemptDbConnection_whenConnectionFails_reportFalse(
    mock_connect: mock.MagicMock,
) -> None:
    """Test _attempt_db_connection when the connection fails."""
    mock_connect.side_effect = jaydebeapi.DatabaseError("Test DB error")

    result = cve_2024_6633._attempt_db_connection("192.168.1.1", 9001)

    assert result is False


@mock.patch("agent.exploits.cve_2024_6633.jaydebeapi.connect")
def testAttemptDbConnection_whenJavaExceptionOccurs_reportFalse(
    mock_connect: mock.MagicMock,
) -> None:
    """Test _attempt_db_connection when a JException occurs."""

    class MockJException(Exception):
        pass

    mock_connect.side_effect = MockJException(
        "java.sql.SQLTransientConnectionException"
    )

    result = cve_2024_6633._attempt_db_connection("192.168.1.1", 9001)

    # Verify that the function returns False
    assert result is False
