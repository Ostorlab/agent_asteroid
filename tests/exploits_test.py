"""Unit tests for Agent Asteriod exploits"""
import re

import requests_mock as req_mock

from agent.exploits import cve_2021_22941
from agent.exploits import cve_2019_12989__cve_2019_12991
from agent import definitions


def testCVE_2021_22941_whenVulnerable_reportFinding(
    requests_mock: req_mock.mocker.Mocker,
) -> None:
    """Unit test for CVE-2021-22941, case when target is vulnerable"""
    target = definitions.Target(scheme="https", host="75.162.65.52", port=443)
    exploit_instance = cve_2021_22941.CVE20222941Exploit()
    requests_mock.post(re.compile("https://75.162.65.52"))
    requests_mock.get(
        re.compile("https://75.162.65.52"),
        content=b'<!DOCTYPE html><html><head><meta charset="utf-8" />'
        b'<meta name="viewport" content="width=device-width" />'
        b"<title></title>"
        b'<link href="/configservice/Content/css?v=WMr-pvK-ldSbNXHT-cT0d9QF2pqi7sqz_4MtKl04wlw1" rel="stylesheet"/>'
        b'<script src="/configservice/bundles/modernizr?v="></script></head>'
        b"<body>__VULNERABLE__/../../ConfigService\\Views\\Shared\\Error.cshtml,"
        b"4190,4190,1,638351359841918992,638351359844106518"
        b'<script src="/configservice/bundles/jquery?v=Btq6NiodC7qP1zsuC2xUYWo89HSxJy2RWUt0n_7RLeM1"></script>'
        b"</body></html>",
    )

    vulnerabilities = exploit_instance.check(target)
    vulnerability = vulnerabilities[0]

    assert (
        vulnerability.entry.title
        == "Improper Access Control in Citrix ShareFile storage zones controller"
    )
    assert (
        vulnerability.technical_detail
        == "https://75.162.65.52 is vulnerable to CVE-2021-22941, Improper Access Control "
        "in Citrix ShareFile storage zones controller"
    )


def test_CVE_2019_12989_and_CVE_2019_12991_whenVulnerable_reportFinding(
    requests_mock: req_mock.mocker.Mocker,
    target_vulnerable_to_cve_2019_12989_cve_2019_12991: definitions.Target,
) -> None:
    """Ensure that the exploit reports findings when the application is vulnerable."""
    exploit_instance = cve_2019_12989__cve_2019_12991.CVE201912989Exploit()
    json_response = {
        "status": "fail",
        "message": "Invalid value specified for site_name or appliance_type",
    }

    requests_mock.post(
        "http://213.174.110.201:80/sdwan/nitro/v1/config/get_package_file?action=file_download",
        json=json_response,
        status_code=400,
    )

    vulnerabilities = exploit_instance.check(
        target_vulnerable_to_cve_2019_12989_cve_2019_12991
    )
    vulnerability = vulnerabilities[0]

    assert (
        vulnerability.entry.title
        == "Security Vulnerabilities in Citrix CVE-2019-12989 and CVE-2019-12991"
    )
    assert (
        vulnerability.technical_detail
        == "213.174.110.201 is vulnerable to CVE-2019-12989 and CVE-2019-12991"
    )
